@using LogiEdge.CustomerService.Data
@using LogiEdge.WarehouseService.Data
@using Microsoft.AspNetCore.Components.Forms
@code {
    [Parameter]
    public required Type ValueType { get; set; }
    [Parameter]
    public EventCallback<DraftPropertyValueInputEventArgs> OnInput { get; set; }
    [Parameter]
    public int? TabIndex { get; set; }
    [Parameter]
    public required object? Value
    {
        set
        {
            if (!Equals(this.value, value))
            {
                this.value = value;
                valueString = value?.ToString();
            }
        }
    }
    private object? value;

    private string? valueString;

    private ElementReference elementRef;

    private bool isInputValid = true;

    private async Task OnInputHandler(ChangeEventArgs e)
    {
        object? val = null;
        if (ValueType == typeof(string))
        {
            isInputValid = true;
            val = e.Value?.ToString();
        }
        else if (ValueType == typeof(int))
        {
            isInputValid = int.TryParse(e.Value?.ToString(), out int valAsInt);
            val = valAsInt;
        } 
        else if (ValueType == typeof(float))
        {
            isInputValid = float.TryParse(e.Value?.ToString(), out float valAsFloat);
            val = valAsFloat;
        }
        else if (ValueType == typeof(DateTime?))
        {
            isInputValid = DateTime.TryParse(e.Value?.ToString(), out DateTime valAsDateTime);
            val = valAsDateTime;
        }
        else
        {
            throw new Exception($"PropertyValueInput: Unsupported ValueType: {ValueType}.");
        }


        
        await OnInput.InvokeAsync(new DraftPropertyValueInputEventArgs()
        {
            IsValid = isInputValid,
            Value = val,
        });
    }

    public async Task FocusAsync()
    {
        await elementRef.FocusAsync();
    }

    public class DraftPropertyValueInputEventArgs : EventArgs
    {
        public required object? Value { get; set; }
        public required bool IsValid { get; set; }
    }
}

@{
    string cls = isInputValid ? "" : "is-invalid";
}

@if (ValueType == typeof(string))
{
    <input
        @ref="elementRef"
        type="text"
           value="@valueString"
        @oninput="OnInputHandler"
        tabindex="@TabIndex"
        class="form-control @cls" />
}
else if (ValueType == typeof(int))
{
    <input 
        @ref="elementRef"
        type="number"
        step="1"
        value="@valueString"
        @oninput="OnInputHandler"
        class="form-control @cls"
        tabindex="@TabIndex"/>
}
else if (ValueType == typeof(float))
{
    <input @ref="elementRef" type="number"
           step="0.1"
           @value="@valueString"
           @oninput="OnInputHandler"
           class="form-control @cls"
           tabindex="@TabIndex" />
}
else if (ValueType == typeof(DateTime?))
{
    <input @ref="elementRef" type="date"
           value="@(valueString ?? string.Empty)"
           @oninput="OnInputHandler"
           class="form-control @cls"
           tabindex="@TabIndex" />
}
else
{
    throw new Exception($"PropertyValueInput: Unsupported ValueType: {ValueType}.");
}
