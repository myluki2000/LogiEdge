@page "/warehouse/transactions/inbound/{TransactionId:guid}"
@using System.ComponentModel.DataAnnotations
@using System.Reflection
@using LogiEdge.BaseService.Data
@using LogiEdge.BaseService.Services
@using LogiEdge.Shared.Attributes
@using LogiEdge.Warehouse.Components
@using LogiEdge.WarehouseService.Data
@using LogiEdge.WarehouseService.Data.Transactions
@using LogiEdge.WarehouseService.Persistence
@using LogiEdge.WebUI.Shared.Components
@using Microsoft.EntityFrameworkCore
@using LogiEdge.CustomerService.Data
@using LogiEdge.Warehouse.Components.InboundTransactionPage
@using Microsoft.AspNetCore.Components.Forms
@inject IDbContextFactory<WarehouseDbContext> WarehouseContextFactory
@inject FileAttachmentService FileAttachmentService

@code {
    /// <summary>
    /// The ID of the transaction this page will show
    /// </summary>
    [Parameter]
    public Guid TransactionId { get; set; }

    private InboundTransaction? Transaction { get; set; }

    private List<(Customer customer, ItemSchema itemSchema)> customerItemSchemasToShow = [];
    private List<FileAttachment> Attachments { get; set; } = [];

    private async Task OnAttachmentsUploaded(List<FileAttachment> newAttachments)
    {
        await using WarehouseDbContext ctx = await WarehouseContextFactory.CreateDbContextAsync();

        InboundTransaction? transaction = ctx.InboundTransactions
            .FirstOrDefault(t => t.Id == TransactionId);

        if (transaction == null)
            return;

        foreach (FileAttachment attachment in newAttachments)
        {
            FileAttachment entity = await FileAttachmentService.CreateAttachmentAsync(attachment);
            transaction.AttachmentIds.Add(entity.Id);
            Attachments.Add(entity);
        }

        await ctx.SaveChangesAsync();
    }

    private async Task OnAttachmentRemoved(Guid attachmentId)
    {
        await using WarehouseDbContext ctx = await WarehouseContextFactory.CreateDbContextAsync();
        InboundTransaction? transaction = ctx.InboundTransactions
            .FirstOrDefault(t => t.Id == TransactionId);
        transaction?.AttachmentIds.Remove(attachmentId);
        await FileAttachmentService.DeleteAttachmentAsync(attachmentId);
        Attachments.RemoveAll(a => a.Id == attachmentId);
        await ctx.SaveChangesAsync();
    }

    public override async Task SetParametersAsync(ParameterView parameters)
    {
        TransactionId = parameters.GetValueOrDefault<Guid>("TransactionId");

        await using WarehouseDbContext ctx = await WarehouseContextFactory.CreateDbContextAsync();

        Transaction = ctx.InboundTransactions
            .FirstOrDefault(t => t.Id == TransactionId);

        if (Transaction != null)
        {
            Attachments = await FileAttachmentService.GetAttachmentsAsync(Transaction.AttachmentIds);
        }

        await base.SetParametersAsync(parameters);
    }
}

@if (Transaction == null)
{
    <p>Could not find transaction with ID @TransactionId</p>
    return;
}


@if (Transaction.State == TransactionState.BOOKED)
{
    <BookedInboundTransactionPageComponent TransactionId="TransactionId" />
}
else
{
    <DraftInboundTransactionPageComponent TransactionId="TransactionId" />
}

<DocumentGeneratorComponent TInputType="InboundTransaction" />

<FileAttachmentManagerComponent Attachments="@Attachments"
                                OnAttachmentsUploaded="OnAttachmentsUploaded"
                                OnAttachmentRemoved="OnAttachmentRemoved" />